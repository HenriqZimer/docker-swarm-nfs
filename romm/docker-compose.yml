services:
  app:
    image: rommapp/romm:latest
    volumes:
      - resources_data:/romm/resources
      - redis_data:/romm/redis-data
      - library_data:/romm/library
      - assets_data:/romm/assets
      - config_data:/romm/config
    environment:
      - DB_HOST=db
      - DB_NAME=romm
      - DB_USER=romm-user
      - DB_PASSWD_FILE=/run/secrets/db_password
      - ROMM_AUTH_SECRET_KEY_FILE=/run/secrets/auth_secret_key
      - HASHEOUS_API_ENABLED=true
      - IGDB_CLIENT_ID_FILE=/run/secrets/igdb_client_id
      - IGDB_CLIENT_SECRET_FILE=/run/secrets/igdb_client_secret
      - STEAMGRIDDB_API_KEY_FILE=/run/secrets/steamgriddb_api_key
      - RETROACHIEVEMENTS_API_KEY_FILE=/run/secrets/retroachievements_api_key
    networks:
      - retro-network
      - traefik-proxy
      - cloudflared-proxy
    healthcheck:
      test:
        - CMD-SHELL
        - curl -f http://localhost:8080/ || exit 1
      interval: 60s
      timeout: 15s
      retries: 5
      start_period: 120s
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == worker
      restart_policy:
        condition: on-failure
        delay: 30s
        max_attempts: 5
        window: 300s
      update_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
        order: stop-first
      rollback_config:
        parallelism: 1
        delay: 30s
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G
      labels:
        - traefik.enable=true
        - traefik.http.routers.romm.rule=Host(`romm.henriqzimer.com.br`)
        - traefik.http.routers.romm.entrypoints=websecure
        - traefik.http.routers.romm.tls=true
        - traefik.http.routers.romm.tls.certresolver=cloudflare
        - traefik.http.routers.romm.middlewares=web-chain@file
        - traefik.http.services.romm.loadbalancer.server.port=8080
    secrets:
      - db_password
      - auth_secret_key
      - igdb_client_id
      - igdb_client_secret
      - steamgriddb_api_key
      - retroachievements_api_key

  db:
    image: mariadb:latest
    volumes:
      - db_data:/var/lib/mysql
    environment:
      - MARIADB_ROOT_PASSWORD_FILE=/run/secrets/db_root_password
      - MARIADB_DATABASE=romm
      - MARIADB_USER=romm-user
      - MARIADB_PASSWORD_FILE=/run/secrets/db_password
    networks:
      - retro-network
    healthcheck:
      test:
        - CMD
        - healthcheck.sh
        - '--connect'
        - '--innodb_initialized'
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 30s
        max_attempts: 5
        window: 300s
      update_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
        order: stop-first
      rollback_config:
        parallelism: 1
        delay: 30s
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 512M
    secrets:
      - db_password
      - db_root_password

volumes:
  db_data:
    driver: local
    driver_opts:
      type: nfs
      o: addr=altaria.henriqzimer.com.br,nfsvers=4,rw
      device: ':/mnt/altaria/docker/romm/db'
  redis_data:
    driver: local
    driver_opts:
      type: nfs
      o: addr=altaria.henriqzimer.com.br,nfsvers=4,rw
      device: ':/mnt/altaria/docker/romm/redis'
  resources_data:
    driver: local
    driver_opts:
      type: nfs
      o: addr=altaria.henriqzimer.com.br,nfsvers=4,rw
      device: ':/mnt/altaria/docker/romm/resources'
  library_data:
    driver: local
    driver_opts:
      type: nfs
      o: addr=slowbro.henriqzimer.com.br,nfsvers=4,rw
      device: ':/mnt/slowbro/library'
  assets_data:
    driver: local
    driver_opts:
      type: nfs
      o: addr=altaria.henriqzimer.com.br,nfsvers=4,rw
      device: ':/mnt/altaria/docker/romm/assets'
  config_data:
    driver: local
    driver_opts:
      type: nfs
      o: addr=altaria.henriqzimer.com.br,nfsvers=4,rw
      device: ':/mnt/altaria/docker/romm/config'

networks:
  retro-network:
    driver: overlay
    driver_opts:
      encrypted: 'true'
    attachable: true
  traefik-proxy:
    external: true
    name: traefik_proxy-network
  cloudflared-proxy:
    external: true
    name: cloudflared_proxy-network

secrets:
  db_password:
    file: ./romm_db_password.txt
  db_root_password:
    file: ./romm_db_root_password.txt
  auth_secret_key:
    file: ./romm_auth_secret_key.txt
  igdb_client_id:
    file: ./romm_igdb_client_id.txt
  igdb_client_secret:
    file: ./romm_igdb_client_secret.txt
  steamgriddb_api_key:
    file: ./romm_steamgriddb_api_key.txt
  retroachievements_api_key:
    file: ./romm_retroachievements_api_key.txt
